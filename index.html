<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>V√¥lei Hub PRO - V9.5</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèê</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        .jogador-card { touch-action: none; border: 2px solid transparent; transition: all 0.2s; cursor: pointer; position: relative; z-index: 10; user-select: none; }
        .sacando { border-color: #f59e0b !important; background-color: #2d3748 !important; box-shadow: 0 0 15px rgba(245, 158, 11, 0.4); }
        .is-estrela { border-right: 4px solid #f59e0b !important; }
        .is-bloqueado { opacity: 0.5; filter: grayscale(1); background: #0f172a !important; border: 1px dashed #334155 !important; }
        .is-proximo { border-left: 4px solid #10b981 !important; background: linear-gradient(90deg, rgba(16, 185, 129, 0.1) 0%, rgba(30, 41, 59, 1) 100%) !important; }
        .tab-active { background-color: #f59e0b !important; color: white !important; }
        .bola-saque { display: none; }
        .sacando .bola-saque { display: inline-block; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
        .config-input { background: #0f172a; border: 1px solid #334155; padding: 10px; border-radius: 12px; width: 100%; color: white; font-weight: bold; font-size: 12px; outline: none; }
        .modal-bottom { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        #info-panel { margin-bottom: 1rem; }
        #live-message-box { min-height: 60px; background: #0f172a; border: 1px solid #334155; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 10px; margin-bottom: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        #match-log-box { max-height: 120px; overflow-y: auto; background: rgba(15, 23, 42, 0.5); border-radius: 8px; padding: 5px; font-size: 10px; border: 1px solid #1e293b; }
        .log-item { padding: 4px 8px; border-radius: 4px; margin-bottom: 2px; font-weight: bold; text-transform: uppercase; display: flex; justify-content: space-between; }
        .log-A { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border-left: 2px solid #3b82f6; }
        .log-B { background: rgba(249, 115, 22, 0.2); color: #fb923c; border-left: 2px solid #f97316; }

        #emoji-layer { position: fixed; inset: 0; pointer-events: none; z-index: 5000; overflow: hidden; }
        .emoji-particle { position: absolute; font-size: 3rem; animation: floatUp ease-out forwards; opacity: 0; text-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        @keyframes floatUp { 
            0% { transform: translateY(110vh) scale(0.5); opacity: 1; } 
            100% { transform: translateY(-10vh) scale(1.5); opacity: 0; } 
        }

        #endgame-overlay { transition: opacity 0.5s; z-index: 99999 !important; }
        .animate-pop { animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 70% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }

        .modal-global { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        #modalWeights { z-index: 2100 !important; }
        
        .hidden { display: none !important; }
        .admin-only-control { display: none !important; }
        .admin-click-only { pointer-events: none; } 
        body.is-admin .admin-only-control { display: block !important; }
        body.is-admin .admin-click-only { pointer-events: auto; cursor: pointer; }
        .admin-section { display: none; } 
        body.is-admin .admin-section { display: block; }
        body.show-public .admin-section { display: block; }
        .player-readonly { pointer-events: none; }
        body.is-admin .player-readonly { pointer-events: auto; }
        #esperaContainer { min-height: 80px; }
        .drag-handle { cursor: grab; padding: 10px; color: #64748b; font-size: 20px; touch-action: none; }
        #admin-notif-bell { position: relative; }
        #admin-notif-dot { position: absolute; top: -2px; right: -2px; width: 10px; height: 10px; background: red; border-radius: 50%; border: 1px solid #1e293b; }
    </style>
</head>
<body class="bg-slate-900 text-white font-sans overflow-x-hidden pb-32">

    <div id="emoji-layer"></div>

    <div id="endgame-overlay" class="fixed inset-0 bg-black/95 hidden flex items-center justify-center flex-col">
        <div class="text-[150px] animate-pop leading-none">üèê</div>
        <h2 class="text-5xl font-black text-orange-500 uppercase italic mt-4 animate-pulse text-center">Fim de<br>Jogo!</h2>
    </div>

    <header class="p-4 bg-slate-800 sticky top-0 shadow-2xl z-40 border-b border-slate-700">
        <div class="flex justify-between items-center max-w-md mx-auto mb-3">
            <h1 onclick="window.adminTriggerWhistle()" class="text-orange-500 font-black text-lg italic uppercase tracking-tighter hover:text-orange-400 active:scale-95 transition admin-click-only cursor-default select-none" title="Clique para tocar apito (Admin Only)">V√¥lei Hub <span class="text-xs text-blue-400">PRO</span></h1>
            <div class="flex gap-2 admin-only-control">
                <button id="admin-notif-bell" onclick="window.abrirSolicitacoes()" class="hidden text-[10px] bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded-lg border border-slate-600 transition">üîî<div id="admin-notif-dot"></div></button>
                <button onclick="window.undoLastAction()" class="text-[10px] bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded-lg border border-slate-600 font-bold uppercase transition">‚Ü© Desfazer</button>
                <button onclick="window.abrirConfig()" class="text-[10px] bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded-lg border border-slate-600 font-bold uppercase transition">‚öôÔ∏è Menu</button>
            </div>
        </div>
        
        <div id="placarDisplay" class="flex justify-around items-center max-w-md mx-auto bg-slate-950 py-4 rounded-2xl border border-slate-800 shadow-lg">
            <div class="text-center w-2/5">
                <p class="text-[9px] uppercase text-blue-400 font-black mb-1 italic">Time A</p>
                <div id="scoreA" class="text-6xl font-black leading-none select-none transition active:scale-95 player-readonly" onclick="window.registrarPontoSimples('A', true, true)">0</div>
                <div id="winsA" class="text-[9px] text-blue-300/40 font-bold mt-2 uppercase italic text-center">Sets: 0</div>
            </div>
            <div class="text-slate-800 font-black text-xl italic">VS</div>
            <div class="text-center w-2/5">
                <p class="text-[9px] uppercase text-orange-400 font-black mb-1 italic">Time B</p>
                <div id="scoreB" class="text-6xl font-black leading-none select-none transition active:scale-95 player-readonly" onclick="window.registrarPontoSimples('B', true, true)">0</div>
                <div id="winsB" class="text-[9px] text-orange-300/40 font-bold mt-2 uppercase italic text-center">Sets: 0</div>
            </div>
        </div>
    </header>

    <main class="p-4 max-w-md mx-auto space-y-4">
        
        <div id="info-panel">
            <div id="live-message-box">
                <h2 id="msg-title" class="text-lg font-black uppercase italic text-white leading-none mb-1">---</h2>
                <p id="msg-sub" class="text-orange-400 font-bold uppercase text-[10px] tracking-widest">---</p>
                <div id="msg-streak" class="hidden mt-1 bg-red-600 text-white px-2 py-0.5 rounded-full text-[9px] font-black uppercase animate-pulse">Sequ√™ncia üî•</div>
            </div>
            <div id="match-log-box">
                <div class="text-center text-slate-500 italic py-2">Hist√≥rico vazio...</div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <div class="space-y-1">
                <h3 class="text-[9px] font-black text-center text-blue-500 uppercase mb-1">Time A</h3>
                <div id="areaA" class="space-y-2 min-h-[160px] bg-slate-800/30 rounded-xl p-2 border border-dashed border-slate-700/50"></div>
            </div>
            <div class="space-y-1">
                <h3 class="text-[9px] font-black text-center text-orange-500 uppercase mb-1">Time B</h3>
                <div id="areaB" class="space-y-2 min-h-[160px] bg-slate-800/30 rounded-xl p-2 border border-dashed border-slate-700/50"></div>
            </div>
        </div>

        <section class="bg-slate-800/50 rounded-2xl border border-slate-700 overflow-hidden shadow-lg">
            <div class="p-3 bg-slate-800/80 border-b border-slate-700 flex justify-between items-center">
                <div class="flex gap-2">
                    <button onclick="window.setFilaTab('geral')" id="tabGeral" class="text-[10px] font-black uppercase px-4 py-2 rounded-lg transition">Geral <span id="countGeral" class="ml-1 opacity-50">0</span></button>
                    <button onclick="window.setFilaTab('estrela')" id="tabEstrela" class="text-[10px] font-black uppercase px-4 py-2 rounded-lg transition">Estrelas ‚≠ê <span id="countEstrela" class="ml-1 opacity-50">0</span></button>
                </div>
                <div id="statusConn" class="text-[8px] text-emerald-500 font-bold uppercase animate-pulse">‚óè Online</div>
            </div>
            <div id="esperaContainer" class="p-4 space-y-2 bg-slate-900/50"></div>
        </section>

        <div class="flex gap-2">
            <input id="novoNome" type="text" placeholder="NOME DO JOGADOR..." class="bg-slate-800 flex-1 p-4 rounded-2xl outline-none border border-slate-700 focus:border-orange-500 text-sm font-bold uppercase placeholder-slate-600">
            <button onclick="window.adicionarNovoJogador()" class="bg-blue-600 hover:bg-blue-500 px-6 rounded-2xl font-black text-sm uppercase transition shadow-lg">Add</button>
        </div>

        <section id="rankingSection" class="bg-slate-900 border border-slate-800 rounded-2xl overflow-hidden shadow-2xl admin-section">
            <div class="p-4 bg-slate-800/60 border-b border-slate-800 text-center">
                <h2 class="text-xs font-black uppercase text-orange-500 italic mb-3 tracking-widest">üèÜ Ranking Master</h2>
                <div class="flex gap-2">
                    <button onclick="window.setRankingTab('tudo')" id="rkTabTudo" class="flex-1 text-[9px] font-black uppercase py-2 rounded-lg bg-slate-700 hover:bg-slate-600">Tudo</button>
                    <button onclick="window.setRankingTab('geral')" id="rkTabGeral" class="flex-1 text-[9px] font-black uppercase py-2 rounded-lg bg-slate-700 hover:bg-slate-600">Geral</button>
                    <button onclick="window.setRankingTab('estrela')" id="rkTabEstrela" class="flex-1 text-[9px] font-black uppercase py-2 rounded-lg bg-slate-700 hover:bg-slate-600">Estrelas ‚≠ê</button>
                </div>
            </div>
            <div id="rankingContainer" class="p-2 space-y-1"></div>
        </section>

        <section id="hallFamaSection" class="space-y-4 admin-section">
            <h2 class="text-xs font-black uppercase text-slate-500 text-center tracking-widest italic">‚ö° Hall da Fama</h2>
            <div id="leadersGrid" class="space-y-3"></div>
        </section>
    </main>

    <div id="modalWeights" class="modal-global hidden">
        <div class="bg-slate-800 w-full max-w-md rounded-3xl p-6 border-2 border-blue-500 overflow-y-auto max-h-[90vh]">
            <h2 class="text-xl font-black text-blue-400 uppercase mb-6 italic">Pesos do Score</h2>
            <div class="space-y-6">
                <div>
                    <h4 class="text-[10px] font-black text-slate-500 uppercase mb-3">Geral</h4>
                    <div class="grid grid-cols-3 gap-2">
                        <div><label class="text-[8px] font-bold">Ataque</label><input type="number" step="0.25" id="wAtqG" class="config-input"></div>
                        <div><label class="text-[8px] font-bold">Bloqueio</label><input type="number" step="0.25" id="wBlqG" class="config-input"></div>
                        <div><label class="text-[8px] font-bold">Ace</label><input type="number" step="0.25" id="wAceG" class="config-input"></div>
                    </div>
                </div>
                <div>
                    <h4 class="text-[10px] font-black text-orange-500 uppercase mb-3">Estrela</h4>
                    <div class="grid grid-cols-3 gap-2">
                        <div><label class="text-[8px] font-bold">Ataque</label><input type="number" step="0.25" id="wAtqE" class="config-input"></div>
                        <div><label class="text-[8px] font-bold">Bloqueio</label><input type="number" step="0.25" id="wBlqE" class="config-input"></div>
                        <div><label class="text-[8px] font-bold">Ace</label><input type="number" step="0.25" id="wAceE" class="config-input"></div>
                    </div>
                </div>
                <div>
                    <h4 class="text-[10px] font-black text-emerald-500 uppercase mb-3">Global</h4>
                    <div class="grid grid-cols-3 gap-2">
                        <div><label class="text-[8px] font-bold">Erro Adv.</label><input type="number" step="0.05" id="wErr" class="config-input"></div>
                        <div><label class="text-[8px] font-bold">Vit√≥ria</label><input type="number" step="0.5" id="wVit" class="config-input"></div>
                        <div><label class="text-[8px] font-bold text-yellow-400">Acerto Time</label><input type="number" step="0.05" id="wTeam" class="config-input border-yellow-500/50"></div>
                    </div>
                    <p class="text-[8px] text-slate-500 mt-2 italic">* Acerto Time: Pontos dados aos companheiros quando algu√©m faz um ponto de ataque.</p>
                </div>
            </div>
            <button onclick="window.salvarWeightsEClose()" class="w-full bg-blue-600 p-4 rounded-xl font-black uppercase italic mt-6">Aplicar (Salvar Config)</button>
            <button onclick="window.fecharModais()" class="w-full py-4 text-slate-500 text-[10px] font-bold uppercase">Cancelar</button>
        </div>
    </div>

    <div id="modalSolicitacoes" class="modal-global hidden">
        <div class="bg-slate-800 w-full max-w-sm rounded-3xl p-6 border-2 border-yellow-500">
            <h2 class="text-xl font-black text-yellow-500 uppercase mb-4 italic">Solicita√ß√µes</h2>
            <div id="listaSolicitacoes" class="space-y-3 max-h-[200px] overflow-y-auto mb-4"></div>
            <button onclick="window.fecharModais()" class="w-full bg-slate-700 py-3 rounded-xl font-bold uppercase text-xs">Fechar</button>
        </div>
    </div>

    <div id="modalConfigMenu" class="modal-global hidden">
        <div class="bg-slate-800 w-full max-w-md rounded-3xl p-6 border border-slate-700 overflow-y-auto max-h-[90vh]">
            <h2 class="text-xl font-black text-orange-500 uppercase mb-6 italic">Configura√ß√µes</h2>
            <div class="space-y-4 mb-6">
                <div class="bg-slate-700/50 p-4 rounded-xl border border-slate-600">
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-black uppercase text-blue-400">Exibir Ranking p/ Todos</span>
                        <button id="btnToggleRank" onclick="window.togglePublicRanking()" class="text-[10px] font-bold uppercase px-3 py-1 rounded bg-slate-900 border border-slate-500 text-slate-400">Desativado</button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[9px] uppercase font-bold text-slate-500">Jogadores/Time</label><input type="number" id="cSize" class="config-input"></div>
                    <div><label class="text-[9px] uppercase font-bold text-slate-500">Max Estrelas</label><input type="number" id="cStars" class="config-input"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[9px] uppercase font-bold text-slate-500">Pontos/Set</label><input type="number" id="cPoints" class="config-input"></div>
                    <div><label class="text-[9px] uppercase font-bold text-slate-500">Max Vit√≥rias</label><input type="number" id="cMax" class="config-input"></div>
                </div>
                <div><label class="text-[9px] uppercase font-bold text-slate-500">Ao atingir limite:</label>
                    <select id="cReaction" class="config-input">
                        <option value="dividir">Dividir Vencedores</option>
                        <option value="sairDois">Sair Ambos</option>
                    </select>
                </div>
                <div><label class="text-[9px] uppercase font-bold text-slate-500">Desempate</label>
                    <select id="cDesempate" class="config-input">
                        <option value="3direto">3 Pontos direto</option>
                        <option value="2vantagem">2 Pontos vantagem</option>
                        <option value="sem">Sem Desempate</option>
                    </select>
                </div>                
                <button onclick="window.abrirWeights()" class="w-full bg-slate-700 text-blue-400 p-3 rounded-xl font-black uppercase text-[10px] border border-slate-600">üìä Pesos do Score</button>
                <button onclick="window.abrirBloqueioDuplas()" class="w-full bg-slate-700 text-red-400 p-3 rounded-xl font-black uppercase text-[10px] border border-slate-600">üö´ Bloqueio Duplas</button>
                <button onclick="window.limparSistema()" class="w-full text-red-600 text-[10px] font-black uppercase py-2">‚ö†Ô∏è Resetar Sistema (Global)</button>
            </div>
            <button onclick="window.salvarConfigEClose()" class="w-full bg-orange-600 p-4 rounded-xl font-black uppercase italic shadow-lg">Salvar Config</button>
            <button onclick="window.fecharModais()" class="w-full py-4 text-slate-500 text-[10px] font-bold uppercase">Fechar</button>
        </div>
    </div>

    <div id="modalAudit" class="modal-global hidden">
        <div class="bg-slate-800 w-full max-w-xs rounded-3xl p-6 border border-orange-500">
            <h3 id="auditNome" class="font-black text-orange-500 uppercase text-lg italic mb-2">---</h3>
            <div class="flex gap-3 mb-6 text-[10px] text-slate-500 italic font-bold">
                <span id="auditLosses">Derrotas: 0</span>
                <span id="auditMatches">Partidas: 0</span>
            </div>
            <div id="auditContent" class="space-y-3 text-[11px]"></div>
            <div class="mt-6 pt-4 border-t border-slate-700 flex justify-between items-center">
                <span class="text-xs font-black uppercase text-slate-400">Total Score</span>
                <span id="auditTotal" class="text-3xl font-black text-orange-500">0</span>
            </div>
            <button onclick="window.fecharModais()" class="w-full mt-6 bg-slate-700 py-3 rounded-xl uppercase text-xs font-black hover:bg-slate-600">Voltar</button>
        </div>
    </div>

    <div id="modalPontoTec" class="fixed inset-0 bg-black/90 hidden z-[100] flex items-end justify-center">
        <div class="bg-slate-800 w-full max-w-md rounded-t-3xl p-6 border-t-2 border-orange-500 modal-bottom">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modalNomeTec" class="font-black text-white uppercase text-xl leading-none italic">---</h3>
                <button onclick="window.fecharModais()" class="text-slate-400 text-3xl font-light">&times;</button>
            </div>
            <div class="grid grid-cols-1 gap-3">
                <div class="admin-only-control space-y-3">
                    <button onclick="window.registrarAcaoJogador('ataque')" class="w-full bg-slate-700 p-4 rounded-2xl font-bold uppercase text-xs flex justify-between italic hover:bg-slate-600">
                        <div class="flex flex-col text-left">
                            <span>üí• Ponto de Ataque</span>
                            <span class="text-[8px] text-slate-400 font-normal normal-case">+0.25 p/ companheiros</span>
                        </div>
                        <span id="labelAtq" class="text-orange-500"></span>
                    </button>
                    <button onclick="window.registrarAcaoJogador('bloqueio')" class="w-full bg-slate-700 p-4 rounded-2xl font-bold uppercase text-xs flex justify-between italic hover:bg-slate-600"><span>üö´ Ponto de Bloqueio</span> <span id="labelBlq" class="text-orange-500"></span></button>
                    <button id="btnAceTec" onclick="window.registrarAcaoJogador('saque')" class="w-full bg-orange-600 p-4 rounded-2xl font-black uppercase text-xs flex justify-between italic hover:bg-orange-500 shadow-lg shadow-orange-900/50"><span>‚ö° Ace de Saque</span> <span id="labelAce"></span></button>
                    <div class="grid grid-cols-2 gap-3 mt-2">
                        <button onclick="window.definirSacadorManual()" class="bg-blue-900/40 text-blue-400 p-3 rounded-xl font-bold uppercase text-[10px] border border-blue-900/30">Definir Sacador</button>
                        <button onclick="window.removerParaFilaManual()" class="bg-red-900/20 text-red-500 p-3 rounded-xl font-bold uppercase text-[10px] border border-red-900/30">Remover p/ Fila</button>
                    </div>
                </div>
                <div id="playerViewMsg" class="text-center text-slate-500 text-xs italic py-4 hidden">Apenas o administrador pode gerenciar pontos.</div>
            </div>
        </div>
    </div>

    <div id="modalFilaEscala" class="modal-global hidden">
        <div class="bg-slate-800 w-full max-w-md rounded-3xl p-6 border border-emerald-500/30">
            <h3 id="modalNomeFila" class="font-black text-white uppercase text-xl italic mb-6">---</h3>
            <div class="grid grid-cols-2 gap-4 mb-4 admin-only-control">
                <div class="space-y-2">
                    <p class="text-[8px] font-black text-blue-400 uppercase text-center italic">Time A</p>
                    <button onclick="window.escalarParaTime('A')" class="w-full bg-blue-600 hover:bg-blue-500 p-3 rounded-xl font-black uppercase text-[10px] transition">Entrar A</button>
                    <div id="subsA" class="space-y-1 max-h-[120px] overflow-y-auto"></div>
                </div>
                <div class="space-y-2">
                    <p class="text-[8px] font-black text-orange-400 uppercase text-center italic">Time B</p>
                    <button onclick="window.escalarParaTime('B')" class="w-full bg-orange-600 hover:bg-orange-500 p-3 rounded-xl font-black uppercase text-[10px] transition">Entrar B</button>
                    <div id="subsB" class="space-y-1 max-h-[120px] overflow-y-auto"></div>
                </div>
            </div>
            <button id="btnStatusBloqueio" class="w-full bg-slate-700 p-3 rounded-xl font-black uppercase text-xs mb-2 hover:bg-slate-600">---</button>
            <button id="btnTrocarCategoria" class="w-full bg-slate-800 text-blue-400 p-3 rounded-xl font-black uppercase text-[10px] border border-blue-900/30 mb-2" onclick="window.solicitarTrocaCategoria()">Trocar Categoria</button>
            <button onclick="window.fecharModais()" class="w-full py-2 text-slate-500 uppercase text-[10px] font-bold">Voltar</button>
        </div>
    </div>

    <div id="modalRestricao" class="modal-global hidden">
        <div class="bg-slate-800 w-full max-w-md rounded-3xl p-6 border border-red-500/30">
            <h2 class="text-xl font-black text-red-500 uppercase mb-4 italic">Vincular Restri√ß√µes</h2>
            <div class="space-y-3 mb-6">
                <select id="selJ1" class="config-input text-xs h-10"></select>
                <select id="selJ2" class="config-input text-xs h-10"></select>
                <button onclick="window.adicionarRestricao()" class="w-full bg-red-600 hover:bg-red-500 py-3 rounded-xl font-black uppercase text-xs italic shadow-lg">Bloquear esta Dupla</button>
            </div>
            <div id="listaRestricoes" class="space-y-2 max-h-[150px] overflow-y-auto mb-4 bg-slate-900/50 p-2 rounded-xl"></div>
            <button onclick="document.getElementById('modalRestricao').classList.add('hidden')" class="w-full bg-slate-700 py-3 rounded-xl font-bold uppercase text-xs">Voltar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDdX-lpFmddIHt2scaramJSyo3RnJOxtO4",
            authDomain: "voleihubpro.firebaseapp.com",
            databaseURL: "https://voleihubpro-default-rtdb.firebaseio.com",
            projectId: "voleihubpro",
            storageBucket: "voleihubpro.firebasestorage.app",
            messagingSenderId: "699650483362",
            appId: "1:699650483362:web:b4f60916984f58a70de3fb"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const gameRef = ref(db, 'partida/v9_5'); // Atualizado para v9.5

        const INITIAL_GERAL = ["MATHEUS MATOS","MARCIANO", "DANIELE", "RAFAEL", "SABRINA", "JANIR", "YURI", "MAICON", "THALYSON", "ODAIR", "LUCAS GABRIEL", "JO√ÉO", "LUIZ EDUARDO", "MATHEUS JAPA", "ANDERSON"];
        const INITIAL_ESTRELA = ["PATY", "MATEUS BRAZ", "RHUANA", "KEMILLY", "WELLINGTON"];
        const PHRASES = ["", "Na conta! Fez 1 ponto.", "Dobradinha! 2 pontos nessa partida", "Pegando fogo! üî• Terceiro ponto nesse jogo.", "Insuport√°vel! 4 pontos e contando...", "M√£o de ferro! üëä 5 pontos feitos", "Dono da quadra! Fez metade do set sozinho!", "Modo God ativado! ‚ö° 7 pontos na partida.", "Chamem o SAMU! J√° s√£o 8 pontos.", "Lend√°rio! 9 pontos na partida.", "10 pontos feitos! Fechem as portas e apaguem as luzes! üèÜ"];
        const DEFAULT_RESTRICTIONS = [["PATY", "MATEUS BRAZ"], ["MARCIANO", "JANIR"], ["RAFAEL", "YURI"], ["MATEUS BRAZ", "YURI"], ["MATHEUS MATOS", "KEMILLY"], ["RHUANA", "YURI"]];

        const params = new URLSearchParams(window.location.search);
        const isAdmin = params.get('admin') === 'true';
        if(isAdmin) document.body.classList.add('is-admin');

        // --- MOTOR DE √ÅUDIO SINT√âTICO (APITO REALISTA) ---
        let audioCtx;
        
        document.addEventListener('click', () => {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }, { once: true });

        function tocarApitoRealista() {
            if (!audioCtx) {
                try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {}
            }
            if (audioCtx && audioCtx.state === 'suspended') { audioCtx.resume(); }
            if (!audioCtx) return;

            const now = audioCtx.currentTime;
            
            // Cria dois osciladores para gerar o efeito de "batimento" (trinado)
            const osc1 = audioCtx.createOscillator();
            const osc2 = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            osc1.type = 'triangle'; // Triangulo soa mais "cheio" que sine
            osc2.type = 'triangle';

            osc1.frequency.setValueAtTime(2000, now);
            osc2.frequency.setValueAtTime(2150, now); // 150Hz de diferen√ßa cria o trinado

            // Envelope de volume (1.2 segundos total)
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(0.8, now + 0.1); // Ataque r√°pido
            gainNode.gain.setValueAtTime(0.8, now + 1.0); // Sustain
            gainNode.gain.linearRampToValueAtTime(0, now + 1.2); // Release r√°pido

            osc1.connect(gainNode);
            osc2.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            osc1.start(now); osc2.start(now);
            osc1.stop(now + 1.2); osc2.stop(now + 1.2);
        }

        let game = {
            partidaAtiva: true, 
            setupLocked: true, 
            scoreA: 0, scoreB: 0, winsConsecA: 0, winsConsecB: 0,
            saqueLado: 'A', idxA: 0, idxB: 0, jaSacouA: false, jaSacouB: false,
            timeA: [], timeB: [], esperaGeral: [], esperaEstrela: [],
            ranking: {}, restricoes: [],
            config: { size: 4, stars: 1, points: 12, desempate: '3direto', maxWins: 3, reaction: 'dividir' },
            weights: { atqG: 1.0, blqG: 1.25, aceG: 1.5, atqE: 1.5, blqE: 2.0, aceE: 2.0, err: 0.10, vit: 3.0, wTeam: 0.25 },
            systemMsg: { text: "AGUARDANDO", sub: "...", streak: false, ts: 0 },
            matchLog: [], lastAnim: { type: '', ts: 0 }, endGameAnim: { active: false, ts: 0 },
            nextGameReason: 'default', publicRanking: false,
            requests: [], deniedRequests: [],
            currentMatchStats: {},
            lastScorerId: null, currentStreak: 0,
            soundTrigger: 0 
        };

        let tempConfig = {};
        let historicoLocal = [];
        let filaTab = 'geral';
        let rkTab = 'tudo';
        let modalCtx = { lado: '', idx: 0 };
        let sortables = [];
        let lastMsgTs = 0;
        let lastAnimTs = 0;
        let lastEndGameTs = 0;
        let lastSoundTs = 0; 

        onValue(gameRef, (snapshot) => {
            const data = snapshot.val();
            if(data) {
                game = { 
                    ...data, 
                    timeA: data.timeA || [], timeB: data.timeB || [], 
                    esperaGeral: data.esperaGeral || [], esperaEstrela: data.esperaEstrela || [], 
                    ranking: data.ranking || {}, restricoes: data.restricoes || [], 
                    systemMsg: data.systemMsg || { text:"AGUARDANDO", sub:"...", ts: 0 }, 
                    matchLog: data.matchLog || [], 
                    lastAnim: data.lastAnim || { ts: 0 }, 
                    endGameAnim: data.endGameAnim || { active: false, ts: 0 }, 
                    nextGameReason: data.nextGameReason || 'default', 
                    publicRanking: data.publicRanking || false, 
                    requests: data.requests || [], deniedRequests: data.deniedRequests || [], 
                    currentMatchStats: data.currentMatchStats || {},
                    soundTrigger: data.soundTrigger || 0,
                    weights: { ...game.weights, ...(data.weights || {}) } 
                };
                ensureRankingConsistency();
                render();
            } else { initGameData(); }
        });

        function ensureRankingConsistency() {
            const allPlayers = [...game.esperaGeral, ...game.esperaEstrela, ...game.timeA, ...game.timeB];
            allPlayers.forEach(p => { 
                if(!game.ranking[p.nome]) {
                    game.ranking[p.nome] = { v:0, d:0, ptsAtaque:0, ptsBloqueio:0, ptsAce:0, ptsErroAdversario:0, ptsAcertoTime: 0, estrela: p.estrela };
                }
                if(typeof game.ranking[p.nome].ptsAcertoTime === 'undefined') {
                    game.ranking[p.nome].ptsAcertoTime = 0;
                }
            });
        }

        function initGameData() {
            game.esperaGeral = []; game.esperaEstrela = [];
            INITIAL_GERAL.forEach(n => adicionarLocal(n, false));
            INITIAL_ESTRELA.forEach(n => adicionarLocal(n, true));
            const all = [...game.esperaGeral, ...game.esperaEstrela];
            game.restricoes = [];
            DEFAULT_RESTRICTIONS.forEach(pair => { const p1 = all.find(p => p.nome === pair[0]); const p2 = all.find(p => p.nome === pair[1]); if(p1 && p2) game.restricoes.push([p1.id, p2.id]); });
            game.esperaGeral.forEach(p => p.bloqueado = true);
            game.esperaEstrela.forEach(p => p.bloqueado = true);
            
            game.partidaAtiva = true; 
            game.saqueLado = 'A'; // Padr√£o
            game.jaSacouA = true; // Se A come√ßa, A j√° "gastou" o saque do jogador 1
            game.jaSacouB = false;

            salvarState();
        }

        function adicionarLocal(nome, isEstrela) {
            const id = Math.random().toString(36).substr(2, 9);
            const obj = { id, nome, estrela: isEstrela, bloqueado: false };
            if(!game.ranking[nome]) game.ranking[nome] = { v:0, d:0, ptsAtaque:0, ptsBloqueio:0, ptsAce:0, ptsErroAdversario:0, ptsAcertoTime: 0, estrela: isEstrela };
            const lista = isEstrela ? game.esperaEstrela : game.esperaGeral;
            let idx = 0;
            for(let i=0; i<lista.length; i++) { const s = game.ranking[lista[i].nome]; if(s && (s.v + s.d) === 0) idx = i + 1; }
            lista.splice(idx, 0, obj);
        }

        function salvarState(pushHist = false) {
            if(pushHist && isAdmin) { historicoLocal.push(JSON.stringify(game)); if(historicoLocal.length > 10) historicoLocal.shift(); }
            set(gameRef, game);
        }

        window.limparSistema = () => {
            if(confirm("‚ö†Ô∏è RESETAR PARA PADR√ÉO DE F√ÅBRICA?")) {
                game.timeA = []; game.timeB = [];
                game.partidaAtiva = true; game.setupLocked = true; 
                game.scoreA = 0; game.scoreB = 0;
                game.winsConsecA = 0; game.winsConsecB = 0;
                game.ranking = {}; game.matchLog = [];
                game.nextGameReason = 'default';
                game.publicRanking = false;
                game.currentMatchStats = {};
                game.requests = []; game.deniedRequests = [];
                game.config = { size: 4, stars: 1, points: 12, desempate: '3direto', maxWins: 3, reaction: 'dividir' };
                game.weights = { atqG: 1.0, blqG: 1.25, aceG: 1.5, atqE: 1.5, blqE: 2.0, aceE: 2.0, err: 0.10, vit: 3.0, wTeam: 0.25 };
                initGameData();
                setSystemMessage("SISTEMA REINICIADO", "Configura√ß√µes Padr√£o Restauradas", false);
            }
        };

        window.adminTriggerWhistle = () => {
            if(!isAdmin) return;
            game.soundTrigger = Date.now();
            salvarState();
        };

        function checkAndPlaySound() {
            if(isAdmin) return; 
            if(game.soundTrigger > lastSoundTs) {
                lastSoundTs = game.soundTrigger;
                tocarApitoRealista();
            }
            if(game.endGameAnim.active && game.endGameAnim.ts > lastEndGameTs) {
                tocarApitoRealista();
            }
        }

        function setSystemMessage(title, sub, streak) { game.systemMsg = { text: title, sub: sub, streak: streak, ts: Date.now() }; }
        function addToLog(text, type) { const entry = { text, type, ts: Date.now() }; game.matchLog.unshift(entry); if(game.matchLog.length > 40) game.matchLog.pop(); }
        function triggerEmoji(type) { game.lastAnim = { type: type, ts: Date.now() }; }
        function showEndGameOverlay() { game.endGameAnim = { active: true, ts: Date.now() }; }

        function render() {
            checkAndPlaySound();

            if(game.endGameAnim && game.endGameAnim.ts > lastEndGameTs) {
                lastEndGameTs = game.endGameAnim.ts;
                const overlay = document.getElementById('endgame-overlay');
                overlay.classList.remove('hidden');
                setTimeout(() => { overlay.classList.add('hidden'); }, 4000); 
            }

            if(game.lastAnim && game.lastAnim.ts > lastAnimTs) { lastAnimTs = game.lastAnim.ts; doEmojiExplosion(game.lastAnim.type); }
            if(game.publicRanking) document.body.classList.add('show-public'); else document.body.classList.remove('show-public');

            document.getElementById('msg-title').innerText = game.systemMsg.text;
            document.getElementById('msg-sub').innerText = game.systemMsg.sub;
            const streakEl = document.getElementById('msg-streak');
            if(game.systemMsg.streak) streakEl.classList.remove('hidden'); else streakEl.classList.add('hidden');

            const logBox = document.getElementById('match-log-box');
            logBox.innerHTML = game.matchLog.length ? game.matchLog.map(l => `<div class="log-item log-${l.type}">${l.text}</div>`).join('') : '<div class="text-center text-slate-500 italic py-2">Hist√≥rico vazio...</div>';

            const infoPanel = document.getElementById('info-panel');
            const placarDiv = document.getElementById('placarDisplay');
            
            placarDiv.classList.remove('hidden'); 
            infoPanel.classList.remove('hidden');
            
            const bell = document.getElementById('admin-notif-bell');
            if(isAdmin && game.requests.length > 0) bell.classList.remove('hidden'); else bell.classList.add('hidden');

            document.getElementById('scoreA').innerText = game.scoreA;
            document.getElementById('scoreB').innerText = game.scoreB;
            document.getElementById('winsA').innerText = `Sets: ${game.winsConsecA}`;
            document.getElementById('winsB').innerText = `Sets: ${game.winsConsecB}`;

            const drawTeam = (l) => (l === 'A' ? game.timeA : game.timeB).map((p, i) => `
                <div class="jogador-card bg-slate-800 p-3 rounded-xl border-l-4 ${l==='A'?'border-l-blue-500':'border-l-orange-500'} ${game.partidaAtiva && game.saqueLado===l && (l==='A'?game.idxA:game.idxB)===i?'sacando':''} ${p.estrela?'is-estrela':''}" onclick="window.abrirPontoTecnico('${l}', ${i})" data-id="${p.id}">
                    <div class="uppercase font-black text-[10px] truncate"><span class="bola-saque mr-1">üèê</span> ${p.estrela?'‚≠ê ':''}${p.nome}</div>
                </div>`).join('');
            document.getElementById('areaA').innerHTML = drawTeam('A');
            document.getElementById('areaB').innerHTML = drawTeam('B');

            const f = filaTab === 'geral' ? game.esperaGeral : game.esperaEstrela;
            let countLib = 0;
            document.getElementById('esperaContainer').innerHTML = f.length ? f.map((p, i) => {
                let dest = "";
                if(!p.bloqueado && filaTab === 'geral') { countLib++; if(countLib<=3) dest="is-proximo"; }
                return `<div data-id="${p.id}" class="bg-slate-800 p-3 rounded-xl flex justify-between items-center border border-slate-700 ${p.bloqueado ? 'is-bloqueado' : ''} ${dest}">
                    <div onclick="window.abrirEscalacao('${filaTab}', ${i})" class="flex-1 text-[10px] font-black uppercase text-slate-300 py-2 cursor-pointer">${p.estrela ? '‚≠ê ' : ''}${p.nome}</div>
                    ${isAdmin ? '<div class="drag-handle hover:text-white">‚†ø</div>' : ''}
                </div>`;
            }).join('') : '<div class="text-center text-slate-600 text-[10px] py-4 italic">Fila vazia...</div>';

            const todos = [...game.timeA, ...game.timeB];
            const cGeral = game.esperaGeral.filter(j=>!j.bloqueado).length + todos.filter(j=>!j.estrela).length;
            const cStar = game.esperaEstrela.filter(j=>!j.bloqueado).length + todos.filter(j=>j.estrela).length;
            document.getElementById('countGeral').innerText = cGeral;
            document.getElementById('countEstrela').innerText = cStar;
            document.getElementById('tabGeral').className = `text-[10px] font-black uppercase px-4 py-2 rounded-lg transition ${filaTab === 'geral' ? 'tab-active shadow-lg' : 'bg-slate-700 hover:bg-slate-600'}`;
            document.getElementById('tabEstrela').className = `text-[10px] font-black uppercase px-4 py-2 rounded-lg transition ${filaTab === 'estrela' ? 'tab-active shadow-lg' : 'bg-slate-700 hover:bg-slate-600'}`;

            const rk = Object.entries(game.ranking).map(([n, s]) => ({ n, ...s, score: parseFloat(getScore(n)) })).filter(x => x.score > 0 && (rkTab==='tudo'?true:rkTab==='estrela'?x.estrela:!x.estrela)).sort((a,b) => b.score - a.score);
            document.getElementById('rankingContainer').innerHTML = rk.map((j, i) => `<div class="flex items-center justify-between bg-slate-800/40 p-3 rounded-xl border border-slate-800 cursor-pointer mb-1 hover:bg-slate-800 transition" onclick="window.abrirAuditModal('${j.n}')"><div class="flex items-center gap-3"><span class="text-[10px] text-slate-600 w-4 font-bold">${i+1}</span><div class="rank-name uppercase text-[10px] font-bold text-slate-300">${j.estrela?'‚≠ê':''} ${j.n}</div></div><div class="text-orange-500 font-black text-xs">${j.score}</div></div>`).join('');
            renderLeaders();
            
            if(isAdmin) {
                sortables.forEach(s => s.destroy());
                sortables = [];
                sortables.push(Sortable.create(document.getElementById('areaA'), { group: 'quadra', animation: 150, onEnd: () => syncQuadra() }));
                sortables.push(Sortable.create(document.getElementById('areaB'), { group: 'quadra', animation: 150, onEnd: () => syncQuadra() }));
                sortables.push(Sortable.create(document.getElementById('esperaContainer'), { handle: '.drag-handle', animation: 150, ghostClass: 'bg-slate-700', onEnd: () => syncFila() }));
            }
        }

        function doEmojiExplosion(type) {
            let icon = '';
            if(type === 'ataque') icon = 'üí•';
            else if(type === 'bloqueio') icon = 'üö´';
            else if(type === 'saque') icon = '‚ö°';
            else return;

            const layer = document.getElementById('emoji-layer');
            for(let i = 0; i < 15; i++) { 
                const el = document.createElement('div');
                el.innerText = icon;
                el.className = 'emoji-particle';
                el.style.left = Math.random() * 100 + 'vw';
                el.style.bottom = '-10vh';
                el.style.animationDuration = (Math.random() * 2 + 3) + 's';
                el.style.fontSize = (Math.random() * 4 + 4) + 'rem';
                layer.appendChild(el);
                setTimeout(() => el.remove(), 5000);
            }
        }

        window.registrarPontoSimples = (lado, hist, isErro) => {
            if(!isAdmin || !game.partidaAtiva) return;
            if(hist) salvarState(true);
            
            if(isErro) {
                const beneficiados = lado === 'A' ? game.timeA : game.timeB;
                beneficiados.forEach(p => game.ranking[p.nome].ptsErroAdversario++);
                addToLog(`PONTO TIME ${lado} - ERRO ADVERS√ÅRIO`, lado);
                setSystemMessage(`TIME ${lado}`, "PONTO POR ERRO", false);
            }

            if(game.saqueLado !== lado) {
                game.saqueLado = lado;
                if(lado === 'A') { if(!game.jaSacouA) game.jaSacouA = true; else game.idxA = (game.idxA + 1) % game.timeA.length; }
                else { if(!game.jaSacouB) game.jaSacouB = true; else game.idxB = (game.idxB + 1) % game.timeB.length; }
            }
            if(lado === 'A') game.scoreA++; else game.scoreB++;
            
            // L√ìGICA DE MATCH POINT
            const limit = game.config.points;
            let isMatchPoint = false;
            
            if(game.config.desempate === '3direto') {
               if((lado==='A' && game.scoreA >= limit-1 && game.scoreA > game.scoreB) || (lado==='B' && game.scoreB >= limit-1 && game.scoreB > game.scoreA)) isMatchPoint = true;
            } else {
               if((lado==='A' && game.scoreA >= limit-1 && game.scoreA > game.scoreB) || (lado==='B' && game.scoreB >= limit-1 && game.scoreB > game.scoreA)) isMatchPoint = true;
            }

            if(isMatchPoint) {
                // PRIORIDADE M√ÅXIMA: Sobrescreve "Ponto por Erro" se for Match Point
                setSystemMessage("MATCH POINT!", `Time ${lado} jogando pelo set`, true);
            } else if (!isErro) {
                // Mensagens secund√°rias (Vai a 3, Vai a 2) s√≥ aparecem se n√£o for erro (para n√£o poluir)
                if(game.config.desempate === '3direto' && game.scoreA === limit-1 && game.scoreB === limit-1) setSystemMessage("VAI A 3!", "Desempate Direto", false);
                else if(game.config.desempate === '2vantagem' && game.scoreA >= limit-1 && game.scoreB >= limit-1 && Math.abs(game.scoreA-game.scoreB) < 2) setSystemMessage("VAI A 2!", "Vantagem Necess√°ria", false);
            }
            
            verificarFimDeSet();
            salvarState(false);
        };

        window.registrarAcaoJogador = (tipo) => {
            if(!isAdmin) return;
            salvarState(true);
            const p = (modalCtx.lado==='A'?game.timeA:game.timeB)[modalCtx.idx];
            
            if(tipo==='ataque') {
                game.ranking[p.nome].ptsAtaque++;
                const timeAtual = modalCtx.lado === 'A' ? game.timeA : game.timeB;
                timeAtual.forEach(companheiro => {
                    if(companheiro.id !== p.id) {
                        game.ranking[companheiro.nome].ptsAcertoTime++;
                    }
                });
            }
            if(tipo==='bloqueio') game.ranking[p.nome].ptsBloqueio++; 
            if(tipo==='saque') game.ranking[p.nome].ptsAce++; 
            
            if(!game.currentMatchStats) game.currentMatchStats = {};
            game.currentMatchStats[p.id] = (game.currentMatchStats[p.id] || 0) + 1;
            
            addToLog(`${tipo.toUpperCase()} - ${p.nome}`, modalCtx.lado);
            triggerEmoji(tipo);
            
            const totalMatch = game.currentMatchStats[p.id]; 
            const fraseIndex = Math.min(totalMatch, 10);
            const frase = PHRASES[fraseIndex] || "";
            
            let isStreak = false;
            if(game.lastScorerId === p.id) { game.currentStreak++; if(game.currentStreak >= 2) isStreak = true; } else { game.lastScorerId = p.id; game.currentStreak = 1; }
            if(frase) setSystemMessage(p.nome, frase, isStreak);
            window.fecharModais();
            window.registrarPontoSimples(modalCtx.lado, false, false);
        };

        function verificarFimDeSet() {
            const limit = game.config.points;
            const modo = game.config.desempate;
            let venceu = null;
            if(modo === 'sem' && (game.scoreA >= limit || game.scoreB >= limit)) venceu = game.scoreA >= limit ? 'A' : 'B';
            else if(modo === '2vantagem') { if(game.scoreA >= limit && game.scoreA >= game.scoreB + 2) venceu = 'A'; else if(game.scoreB >= limit && game.scoreB >= game.scoreA + 2) venceu = 'B'; }
            else if(modo === '3direto') { if(game.scoreA >= limit && game.scoreA >= game.scoreB + 2) venceu = 'A'; else if(game.scoreB >= limit && game.scoreB >= game.scoreA + 2) venceu = 'B'; if(!venceu && (game.scoreA > limit + 2 || game.scoreB > limit + 2)) venceu = game.scoreA > game.scoreB ? 'A' : 'B'; }
            if(venceu) setTimeout(() => finalizarPartida(venceu), 200);
        }

        function finalizarPartida(venceu) {
            setSystemMessage(`VIT√ìRIA TIME ${venceu}!`, "Set Finalizado", false);
            showEndGameOverlay(); 
            const tV = venceu === 'A' ? game.timeA : game.timeB;
            const tD = venceu === 'A' ? game.timeB : game.timeA;
            tV.forEach(j => game.ranking[j.nome].v++);
            tD.forEach(j => { game.ranking[j.nome].d++; (j.estrela ? game.esperaEstrela : game.esperaGeral).push(j); });
            if(venceu === 'A') { game.timeB = []; game.winsConsecA++; game.winsConsecB = 0; } else { game.timeA = []; game.winsConsecB++; game.winsConsecA = 0; }
            
            game.currentMatchStats = {};
            game.lastScorerId = null; game.currentStreak = 0; game.nextGameReason = 'default';
            
            if(game.config.maxWins > 0 && (game.winsConsecA >= game.config.maxWins || game.winsConsecB >= game.config.maxWins)) {
                if(game.config.reaction === 'dividir') { 
                    game.nextGameReason = 'mixed'; 
                    const pool = [...tV].sort((a,b) => getScore(b.nome) - getScore(a.nome)); 
                    const half = Math.ceil(pool.length / 2); 
                    game.timeA = pool.slice(0, half); 
                    game.timeB = pool.slice(half);
                    // AVISO DE TIMES MISTURADOS
                    setSystemMessage("TIMES MISTURADOS", "Limite de Vit√≥rias Atingido", false);
                }
                else { 
                    game.nextGameReason = 'new'; 
                    tV.forEach(j => (j.estrela ? game.esperaEstrela : game.esperaGeral).push(j)); 
                    game.timeA = []; game.timeB = []; 
                }
                game.winsConsecA = 0; game.winsConsecB = 0;
            }
            const fill = (time) => { while(time.length < game.config.size) { let p = null; const precisaStar = time.filter(x=>x.estrela).length < game.config.stars; if(precisaStar) p = game.esperaEstrela.find(x => !x.bloqueado && !time.some(j=>estaoBloqueados(x,j))); if(!p) p = game.esperaGeral.find(x => !x.bloqueado && !time.some(j=>estaoBloqueados(x,j))); if(!p && !precisaStar) p = game.esperaEstrela.find(x => !x.bloqueado && !time.some(j=>estaoBloqueados(x,j))); if(!p) p = game.esperaGeral.find(x => !x.bloqueado) || game.esperaEstrela.find(x => !x.bloqueado); if(!p) break; const f = p.estrela ? game.esperaEstrela : game.esperaGeral; f.splice(f.indexOf(p), 1); time.push(p); } };
            fill(game.timeA); fill(game.timeB);
            game.scoreA = 0; game.scoreB = 0; game.idxA = 0; game.idxB = 0; 
            
            // CORRE√á√ÉO: QUEM GANHOU COME√áA SACANDO, E JA 'GASTOU' O SAQUE 1
            game.saqueLado = venceu;
            game.jaSacouA = (venceu === 'A');
            game.jaSacouB = (venceu === 'B');

            game.partidaAtiva = true; 
            salvarState();
        }

        window.abrirConfig = () => {
            tempConfig = JSON.parse(JSON.stringify(game.config)); 
            tempConfig.publicRanking = game.publicRanking; 
            
            document.getElementById('cSize').value = tempConfig.size;
            document.getElementById('cStars').value = tempConfig.stars;
            document.getElementById('cPoints').value = tempConfig.points;
            document.getElementById('cMax').value = tempConfig.maxWins;
            document.getElementById('cReaction').value = tempConfig.reaction;
            document.getElementById('cDesempate').value = tempConfig.desempate;
            
            updateToggleBtnUI();
            document.getElementById('modalConfigMenu').classList.remove('hidden');
        };

        window.togglePublicRanking = () => {
            tempConfig.publicRanking = !tempConfig.publicRanking;
            updateToggleBtnUI();
        };

        function updateToggleBtnUI() {
            const btn = document.getElementById('btnToggleRank');
            if(tempConfig.publicRanking) {
                btn.innerText = "ATIVADO (Salvar p/ Aplicar)";
                btn.className = "text-[10px] font-bold uppercase px-3 py-1 rounded bg-slate-900 border border-green-500 text-green-400";
            } else {
                btn.innerText = "DESATIVADO";
                btn.className = "text-[10px] font-bold uppercase px-3 py-1 rounded bg-slate-900 border border-slate-500 text-slate-400";
            }
        }

        window.salvarConfigEClose = () => {
            game.config.size = parseInt(document.getElementById('cSize').value);
            game.config.stars = parseInt(document.getElementById('cStars').value);
            game.config.points = parseInt(document.getElementById('cPoints').value);
            game.config.maxWins = parseInt(document.getElementById('cMax').value);
            game.config.reaction = document.getElementById('cReaction').value;
            game.config.desempate = document.getElementById('cDesempate').value;
            game.publicRanking = tempConfig.publicRanking;
            
            window.fecharModais();
            salvarState();
        };

        window.solicitarTrocaCategoria = () => {
            const p = modalCtx.pFila;
            if(game.deniedRequests.includes(p.id)) { alert("Altera√ß√£o Negada pelo Admin."); return; }
            const req = { id: p.id, nome: p.nome };
            if(!game.requests.some(r => r.id === req.id)) {
                game.requests.push(req);
                alert("Solicita√ß√£o enviada ao Admin!");
                salvarState();
            } else { alert("J√° solicitado."); }
            window.abrirEscalacao(modalCtx.tabFila, modalCtx.idxFila); 
        };

        window.abrirSolicitacoes = () => {
            const container = document.getElementById('listaSolicitacoes');
            if(game.requests.length === 0) container.innerHTML = '<div class="text-slate-500 text-xs italic">Nenhuma solicita√ß√£o.</div>';
            else {
                container.innerHTML = game.requests.map((r, i) => `
                    <div class="bg-slate-700 p-2 rounded flex justify-between items-center text-xs">
                        <span>${r.nome}</span>
                        <div class="flex gap-1">
                            <button onclick="window.responderSolicitacao(${i}, true)" class="bg-green-600 px-2 py-1 rounded">‚úî</button>
                            <button onclick="window.responderSolicitacao(${i}, false)" class="bg-red-600 px-2 py-1 rounded">‚úñ</button>
                        </div>
                    </div>
                `).join('');
            }
            document.getElementById('modalSolicitacoes').classList.remove('hidden');
        };

        window.responderSolicitacao = (idx, aprovado) => {
            const req = game.requests[idx];
            if(aprovado) {
                const list = game.esperaGeral.find(x=>x.id===req.id) ? game.esperaGeral : game.esperaEstrela;
                const p = list.find(x=>x.id===req.id);
                if(p) {
                    list.splice(list.indexOf(p), 1);
                    p.estrela = !p.estrela;
                    (p.estrela ? game.esperaEstrela : game.esperaGeral).push(p);
                    if(game.ranking[p.nome]) game.ranking[p.nome].estrela = p.estrela;
                }
            } else {
                game.deniedRequests.push(req.id);
            }
            game.requests.splice(idx, 1);
            window.abrirSolicitacoes(); 
            salvarState();
        };

        function renderLeaders() {
            const pl = Object.entries(game.ranking).map(([n, s]) => ({ n, ...s, score: parseFloat(getScore(n)) }));
            const cats = [{t:"Top Score",i:"üèÜ",f:p=>p.score},{t:"Matador",i:"üî•",f:p=>p.ptsAtaque},{t:"Pared√£o",i:"üö´",f:p=>p.ptsBloqueio},{t:"Ace",i:"‚ö°",f:p=>p.ptsAce},{t:"Vit√≥rias",i:"ü•á",f:p=>p.v}];
            document.getElementById('leadersGrid').innerHTML = cats.map(c => {
                const sort = (l) => [...l].sort((a,b)=>c.f(b)-c.f(a));
                const listG = sort(pl.filter(x=>!x.estrela)); const listE = sort(pl.filter(x=>x.estrela));
                const maxG = listG.length ? c.f(listG[0]) : 0; const maxE = listE.length ? c.f(listE[0]) : 0;
                if(maxG === 0 && maxE === 0) return '';
                const winnersG = listG.filter(p => c.f(p) === maxG).map(p => p.n).join(', ');
                const winnersE = listE.filter(p => c.f(p) === maxE).map(p => p.n).join(', ');

                return `<div class="bg-slate-800 p-3 rounded border border-slate-700 mb-2">
                    <div class="text-xs text-slate-400 mb-1 font-bold tracking-widest uppercase">${c.i} ${c.t}</div>
                    <div class="flex flex-col gap-1 text-[10px]">
                        <div class="flex justify-between items-center bg-slate-700/30 p-1 rounded">
                            <div class="text-lg font-black text-orange-500 whitespace-normal leading-tight w-4/5">${maxG > 0 ? winnersG : '-'}</div>
                            <div class="font-bold text-2xl text-white">${maxG > 0 ? maxG : ''}</div>
                        </div>
                        <div class="flex justify-between items-center bg-slate-700/30 p-1 rounded">
                            <div class="text-lg font-black text-orange-500 whitespace-normal leading-tight w-4/5">${maxE > 0 ? winnersE : '-'}</div>
                            <div class="font-bold text-2xl text-white">${maxE > 0 ? maxE : ''}</div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        window.abrirAuditModal = (n) => {
            const s = game.ranking[n]; const w = game.weights;
            const atqW = s.estrela ? w.atqE : w.atqG; const blqW = s.estrela ? w.blqE : w.blqG; const aceW = s.estrela ? w.aceE : w.aceG;
            document.getElementById('auditNome').innerText = n;
            document.getElementById('auditLosses').innerText = `Derrotas: ${s.d}`;
            document.getElementById('auditMatches').innerText = `Partidas: ${s.v + s.d}`;
            document.getElementById('auditContent').innerHTML = `
                <div class="flex justify-between"><span>Vit√≥rias (x${w.vit}):</span> <b class="text-white">${s.v}</b></div>
                <div class="flex justify-between"><span>Ataques (x${atqW}):</span> <b class="text-white">${s.ptsAtaque}</b></div>
                <div class="flex justify-between"><span>Bloqueios (x${blqW}):</span> <b class="text-white">${s.ptsBloqueio}</b></div>
                <div class="flex justify-between"><span>Aces (x${aceW}):</span> <b class="text-white">${s.ptsAce}</b></div>
                <div class="flex justify-between"><span>Erro Adv. (x${w.err}):</span> <b class="text-white">${s.ptsErroAdversario}</b></div>
                <div class="flex justify-between text-yellow-500"><span>Acerto Time (x${w.wTeam}):</span> <b>${s.ptsAcertoTime}</b></div>
            `;
            document.getElementById('auditTotal').innerText = getScore(n);
            document.getElementById('modalAudit').classList.remove('hidden');
        };

        window.abrirWeights = () => { 
            document.getElementById('modalConfigMenu').classList.add('hidden');
            document.getElementById('wAtqG').value = game.weights.atqG; document.getElementById('wBlqG').value = game.weights.blqG; document.getElementById('wAceG').value = game.weights.aceG; document.getElementById('wAtqE').value = game.weights.atqE; document.getElementById('wBlqE').value = game.weights.blqE; document.getElementById('wAceE').value = game.weights.aceE; document.getElementById('wErr').value = game.weights.err; document.getElementById('wVit').value = game.weights.vit; 
            document.getElementById('wTeam').value = game.weights.wTeam;
            document.getElementById('modalWeights').classList.remove('hidden'); 
        };
        window.fecharModais = () => {
            document.querySelectorAll('.modal-global, #modalPontoTec').forEach(m => m.classList.add('hidden'));
        };
        window.setFilaTab = (t) => { filaTab = t; render(); };
        window.setRankingTab = (t) => { rkTab = t; render(); };
        window.abrirBloqueioDuplas = () => { const all = [...game.timeA, ...game.timeB, ...game.esperaGeral, ...game.esperaEstrela].sort((a,b)=>a.nome.localeCompare(b.nome)); const opt = `<option value="" disabled selected>- Selecione -</option>`+all.map(p=>`<option value="${p.id}">${p.nome}</option>`).join(''); document.getElementById('selJ1').innerHTML = opt; document.getElementById('selJ2').innerHTML = opt; window.renderListaRestricoes(); document.getElementById('modalRestricao').classList.remove('hidden'); };
        window.renderListaRestricoes = () => { const all = [...game.timeA, ...game.timeB, ...game.esperaGeral, ...game.esperaEstrela]; document.getElementById('listaRestricoes').innerHTML = game.restricoes.map((r,i) => { const n1 = all.find(x=>x.id==r[0])?.nome||'?'; const n2 = all.find(x=>x.id==r[1])?.nome||'?'; return `<div class="bg-slate-800 p-2 flex justify-between text-[10px] text-red-400 border border-red-900/30"><span>${n1} üö´ ${n2}</span><button onclick="window.removeRestricao(${i})">X</button></div>`; }).join(''); };
        window.removeRestricao = (i) => { game.restricoes.splice(i,1); window.renderListaRestricoes(); salvarState(); };
        
        window.salvarWeightsEClose = () => { 
            game.weights.atqG = parseFloat(document.getElementById('wAtqG').value); game.weights.blqG = parseFloat(document.getElementById('wBlqG').value); game.weights.aceG = parseFloat(document.getElementById('wAceG').value); game.weights.atqE = parseFloat(document.getElementById('wAtqE').value); game.weights.blqE = parseFloat(document.getElementById('wBlqE').value); game.weights.aceE = parseFloat(document.getElementById('wAceE').value); game.weights.err = parseFloat(document.getElementById('wErr').value); game.weights.vit = parseFloat(document.getElementById('wVit').value); 
            game.weights.wTeam = parseFloat(document.getElementById('wTeam').value);

            document.getElementById('modalWeights').classList.add('hidden');
            window.abrirConfig(); 
        };
        window.adicionarNovoJogador = () => { const n = document.getElementById('novoNome').value.toUpperCase().trim(); if(!n) return; adicionarLocal(n, filaTab==='estrela'); document.getElementById('novoNome').value=''; salvarState(); };
        window.adicionarRestricao = () => { const j1 = document.getElementById('selJ1').value, j2 = document.getElementById('selJ2').value; if(j1&&j2&&j1!==j2) { game.restricoes.push([j1,j2]); window.renderListaRestricoes(); salvarState(); } };
        window.escalarParaTime = (lado) => { const t = lado==='A'?game.timeA:game.timeB; if(t.length<game.config.size) { const l = modalCtx.tabFila==='geral'?game.esperaGeral:game.esperaEstrela; const p = l.splice(modalCtx.idxFila, 1)[0]; p.bloqueado=false; t.push(p); window.fecharModais(); salvarState(); } else alert("Time Cheio!"); };
        function syncQuadra() { if(!isAdmin) return; const p = [...game.timeA, ...game.timeB]; const get = (id) => [...document.getElementById(id).children].map(e => p.find(x => x.id === e.dataset.id)).filter(x=>x); game.timeA = get('areaA'); game.timeB = get('areaB'); salvarState(); }
        function syncFila() { if(!isAdmin) return; const l = filaTab==='geral'?game.esperaGeral:game.esperaEstrela; const els = document.getElementById('esperaContainer').children; const novos = [...els].map(e => l.find(x => x.id === e.dataset.id)).filter(x=>x); if(filaTab==='geral') game.esperaGeral = novos; else game.esperaEstrela = novos; salvarState(); }
        window.abrirEscalacao = (tab, idx) => { const l = tab==='geral'?game.esperaGeral:game.esperaEstrela; modalCtx = { pFila: l[idx], idxFila: idx, tabFila: tab }; document.getElementById('modalNomeFila').innerText = modalCtx.pFila.nome; const btn = document.getElementById('btnStatusBloqueio'); const btnTroca = document.getElementById('btnTrocarCategoria'); btn.innerText = modalCtx.pFila.bloqueado ? "LIBERAR" : "BLOQUEAR"; btn.onclick = () => { modalCtx.pFila.bloqueado = !modalCtx.pFila.bloqueado; window.fecharModais(); salvarState(); }; if(game.requests.some(r=>r.id===modalCtx.pFila.id)) btnTroca.innerText = "SOLICITADO..."; else if(game.deniedRequests.includes(modalCtx.pFila.id)) { btnTroca.innerText = "ALTERA√á√ÉO NEGADA"; btnTroca.classList.add('opacity-50'); } else btnTroca.innerText = "TROCAR CATEGORIA"; if(isAdmin) { const gen = (t, side) => t.map((j, i) => `<button onclick="window.substituirJogador('${side}', ${i})" class="w-full bg-slate-700 p-2 rounded text-[9px] mb-1 uppercase border border-slate-600">Sub: ${j.nome}</button>`).join(''); document.getElementById('subsA').innerHTML = gen(game.timeA, 'A'); document.getElementById('subsB').innerHTML = gen(game.timeB, 'B'); } document.getElementById('modalFilaEscala').classList.remove('hidden'); };
        window.substituirJogador = (side, idx) => { const t = side==='A'?game.timeA:game.timeB; if(estaoBloqueados(modalCtx.pFila, t[idx])) return alert("Bloqueado!"); const sai = t.splice(idx, 1)[0]; const entra = (modalCtx.tabFila==='geral'?game.esperaGeral:game.esperaEstrela).splice(modalCtx.idxFila, 1)[0]; entra.bloqueado = false; t.splice(idx, 0, entra); (sai.estrela?game.esperaEstrela:game.esperaGeral).push(sai); window.fecharModais(); salvarState(); };
        window.undoLastAction = () => { if(!isAdmin || historicoLocal.length===0) return; game = JSON.parse(historicoLocal.pop()); set(gameRef, game); };
        window.definirSacadorManual = () => { game.saqueLado = modalCtx.lado; if(modalCtx.lado === 'A') { game.idxA = modalCtx.idx; game.jaSacouA = true; } else { game.idxB = modalCtx.idx; game.jaSacouB = true; } window.fecharModais(); salvarState(); };
        window.removerParaFilaManual = () => { salvarState(true); const t = modalCtx.lado==='A'?game.timeA:game.timeB; const p = t.splice(modalCtx.idx, 1)[0]; (p.estrela?game.esperaEstrela:game.esperaGeral).push(p); window.fecharModais(); salvarState(false); };
        window.abrirPontoTecnico = (l, i) => { modalCtx = { lado: l, idx: i }; const p = (l==='A'?game.timeA:game.timeB)[i]; document.getElementById('modalNomeTec').innerText = p.nome; if(isAdmin) { const w = game.weights; document.getElementById('labelAtq').innerText = `+${p.estrela?w.atqE:w.atqG}`; document.getElementById('labelBlq').innerText = `+${p.estrela?w.blqE:w.blqG}`; document.getElementById('labelAce').innerText = `+${p.estrela?w.aceE:w.aceG}`; const isSacador = (game.saqueLado === l && (l==='A'?game.idxA:game.idxB)===i); const btn = document.getElementById('btnAceTec'); if(!isSacador) btn.classList.add('opacity-50','pointer-events-none'); else btn.classList.remove('opacity-50','pointer-events-none'); document.getElementById('playerViewMsg').classList.add('hidden'); } else { document.getElementById('playerViewMsg').classList.remove('hidden'); } document.getElementById('modalPontoTec').classList.remove('hidden'); };
        
        function getScore(n) { 
            const s = game.ranking[n]; 
            if(!s) return 0; 
            const w = game.weights; 
            const ptsAtq = s.ptsAtaque * (s.estrela ? w.atqE : w.atqG);
            const ptsBlq = s.ptsBloqueio * (s.estrela ? w.blqE : w.blqG);
            const ptsAce = s.ptsAce * (s.estrela ? w.aceE : w.aceG);
            const ptsErr = s.ptsErroAdversario * w.err;
            const ptsVit = s.v * w.vit;
            const ptsTeam = (s.ptsAcertoTime || 0) * w.wTeam;
            return (ptsVit + ptsAtq + ptsBlq + ptsAce + ptsErr + ptsTeam).toFixed(2); 
        }

        function estaoBloqueados(p1, p2) { return game.restricoes.some(d => (d[0]==p1.id && d[1]==p2.id) || (d[1]==p1.id && d[0]==p2.id)); }
    </script>
</body>
</html>
